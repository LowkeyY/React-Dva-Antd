var dialog=window.parent;var oEditor=dialog.InnerDialogLoaded();var FCK=oEditor.FCK;var FCKLang=oEditor.FCKLang;var FCKConfig=oEditor.FCKConfig;var FCKRegexLib=oEditor.FCKRegexLib;var FCKTools=oEditor.FCKTools;dialog.AddTab("Info",FCKLang.DlgLnkInfoTab);if(!FCKConfig.LinkDlgHideTarget){dialog.AddTab("Target",FCKLang.DlgLnkTargetTab,true);}if(FCKConfig.LinkUpload){dialog.AddTab("Upload",FCKLang.DlgLnkUpload,true);}if(!FCKConfig.LinkDlgHideAdvanced){dialog.AddTab("Advanced",FCKLang.DlgAdvancedTag);}function OnDialogTabChange(A){ShowE("divInfo",(A=="Info"));ShowE("divTarget",(A=="Target"));ShowE("divUpload",(A=="Upload"));ShowE("divAttribs",(A=="Advanced"));dialog.SetAutoSize(true);}var oRegex=new Object();oRegex.UriProtocol=/^(((http|https|ftp|news):\/\/)|mailto:)/gi;oRegex.UrlOnChangeProtocol=/^(http|https|ftp|news):\/\/(?=.)/gi;oRegex.UrlOnChangeTestOther=/^((javascript:)|[#\/\.])/gi;oRegex.ReserveTarget=/^_(blank|self|top|parent)$/i;oRegex.PopupUri=/^javascript:void\(\s*window.open\(\s*'([^']+)'\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*\)\s*$/;oRegex.OnClickPopup=/^\s*on[cC]lick="\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*"$/;oRegex.PopupFeatures=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var oParser=new Object();oParser.ParseEMailUrl=function(C){var A=new Object();A.Address="";A.Subject="";A.Body="";var B=C.match(/^([^\?]+)\??(.+)?/);if(B){A.Address=B[1];if(B[2]){var D=B[2].match(/(^|&)subject=([^&]+)/i);if(D){A.Subject=decodeURIComponent(D[2]);}D=B[2].match(/(^|&)body=([^&]+)/i);if(D){A.Body=decodeURIComponent(D[2]);}}}return A;};oParser.CreateEMailUri=function(B,D,A){var E="mailto:"+B;var C="";if(D.length>0){C="?subject="+encodeURIComponent(D);}if(A.length>0){C+=(C.length==0?"?":"&");C+="body="+encodeURIComponent(A);}return E+C;};var oLink=dialog.Selection.GetSelection().MoveToAncestorNode("A");if(oLink){FCK.Selection.SelectNode(oLink);}window.onload=function(){oEditor.FCKLanguageManager.TranslatePage(document);LoadAnchorNamesAndIds();LoadSelection();SetLinkType(GetE("cmbLinkType").value);GetE("divBrowseServer").style.display=FCKConfig.LinkBrowser?"":"none";GetE("divInfo").style.display="";if(FCKConfig.LinkUpload){GetE("frmUpload").action=FCKConfig.LinkUploadURL;}SetDefaultTarget();dialog.SetOkButton(true);SelectField("txtUrl");};var bHasAnchors;function LoadAnchorNamesAndIds(){var A=new Array();var C;var B=oEditor.FCK.EditorDocument.getElementsByTagName("IMG");for(C=0;C<B.length;C++){if(B[C].getAttribute("_fckanchor")){A[A.length]=oEditor.FCK.GetRealElement(B[C]);}}var F=oEditor.FCK.EditorDocument.getElementsByTagName("A");for(C=0;C<F.length;C++){if(F[C].name&&(F[C].name.length>0)){A[A.length]=F[C];}}var D=FCKTools.GetAllChildrenIds(oEditor.FCK.EditorDocument.body);bHasAnchors=(A.length>0||D.length>0);for(C=0;C<A.length;C++){var E=A[C].name;if(E&&E.length>0){FCKTools.AddSelectOption(GetE("cmbAnchorName"),E,E);}}for(C=0;C<D.length;C++){FCKTools.AddSelectOption(GetE("cmbAnchorId"),D[C],D[C]);}ShowE("divSelAnchor",bHasAnchors);ShowE("divNoAnchor",!bHasAnchors);}function LoadSelection(){if(!oLink){return ;}var A="url";var F=oLink.getAttribute("_fcksavedurl");if(F==null){F=oLink.getAttribute("href",2)||"";}var H=oRegex.PopupUri.exec(F);if(H){GetE("cmbTarget").value="popup";F=H[1];FillPopupFields(H[2],H[3]);SetTarget("popup");}if(!H){var I=oLink.getAttribute("onclick_fckprotectedatt");if(I){I=decodeURIComponent(I);H=oRegex.OnClickPopup.exec(I);if(H){GetE("cmbTarget").value="popup";FillPopupFields(H[1],H[2]);SetTarget("popup");}}}var E=oRegex.UriProtocol.exec(F);if(E){E=E[0].toLowerCase();GetE("cmbLinkProtocol").value=E;var B=F.replace(oRegex.UriProtocol,"");if(E=="mailto:"){A="email";var G=oParser.ParseEMailUrl(B);GetE("txtEMailAddress").value=G.Address;GetE("txtEMailSubject").value=G.Subject;GetE("txtEMailBody").value=G.Body;}else{A="url";GetE("txtUrl").value=B;}}else{if(F.substr(0,1)=="#"&&F.length>1){A="anchor";GetE("cmbAnchorName").value=GetE("cmbAnchorId").value=F.substr(1);}else{A="url";GetE("cmbLinkProtocol").value="";GetE("txtUrl").value=F;}}if(!H){var C=oLink.target;if(C&&C.length>0){if(oRegex.ReserveTarget.test(C)){C=C.toLowerCase();GetE("cmbTarget").value=C;}else{GetE("cmbTarget").value="frame";}GetE("txtTargetFrame").value=C;}}GetE("txtAttId").value=oLink.id;GetE("txtAttName").value=oLink.name;GetE("cmbAttLangDir").value=oLink.dir;GetE("txtAttLangCode").value=oLink.lang;GetE("txtAttAccessKey").value=oLink.accessKey;GetE("txtAttTabIndex").value=oLink.tabIndex<=0?"":oLink.tabIndex;GetE("txtAttTitle").value=oLink.title;GetE("txtAttContentType").value=oLink.type;GetE("txtAttCharSet").value=oLink.charset;var D;if(oEditor.FCKBrowserInfo.IsIE){D=oLink.getAttribute("className",2)||"";D=D.replace(FCKRegexLib.FCK_Class,"");GetE("txtAttStyle").value=oLink.style.cssText;}else{D=oLink.getAttribute("class",2)||"";GetE("txtAttStyle").value=oLink.getAttribute("style",2)||"";}GetE("txtAttClasses").value=D;GetE("cmbLinkType").value=A;}function SetLinkType(A){ShowE("divLinkTypeUrl",(A=="url"));ShowE("divLinkTypeAnchor",(A=="anchor"));ShowE("divLinkTypeEMail",(A=="email"));if(!FCKConfig.LinkDlgHideTarget){dialog.SetTabVisibility("Target",(A=="url"));}if(FCKConfig.LinkUpload){dialog.SetTabVisibility("Upload",(A=="url"));}if(!FCKConfig.LinkDlgHideAdvanced){dialog.SetTabVisibility("Advanced",(A!="anchor"||bHasAnchors));}if(A=="email"){dialog.SetAutoSize(true);}}function SetTarget(A){GetE("tdTargetFrame").style.display=(A=="popup"?"none":"");GetE("tdPopupName").style.display=GetE("tablePopupFeatures").style.display=(A=="popup"?"":"none");switch(A){case"_blank":case"_self":case"_parent":case"_top":GetE("txtTargetFrame").value=A;break;case"":GetE("txtTargetFrame").value="";break;}if(A=="popup"){dialog.SetAutoSize(true);}}function OnUrlChange(){var A=GetE("txtUrl").value;var B=oRegex.UrlOnChangeProtocol.exec(A);if(B){A=A.substr(B[0].length);GetE("txtUrl").value=A;GetE("cmbLinkProtocol").value=B[0].toLowerCase();}else{if(oRegex.UrlOnChangeTestOther.test(A)){GetE("cmbLinkProtocol").value="";}}}function OnTargetNameChange(){var A=GetE("txtTargetFrame").value;if(A.length==0){GetE("cmbTarget").value="";}else{if(oRegex.ReserveTarget.test(A)){GetE("cmbTarget").value=A.toLowerCase();}else{GetE("cmbTarget").value="frame";}}}function BuildOnClickPopup(){var D="'"+GetE("txtPopupName").value.replace(/\W/gi,"")+"'";var C="";var B=document.getElementsByName("chkFeature");for(var A=0;A<B.length;A++){if(A>0){C+=",";}C+=B[A].value+"="+(B[A].checked?"yes":"no");}if(GetE("txtPopupWidth").value.length>0){C+=",width="+GetE("txtPopupWidth").value;}if(GetE("txtPopupHeight").value.length>0){C+=",height="+GetE("txtPopupHeight").value;}if(GetE("txtPopupLeft").value.length>0){C+=",left="+GetE("txtPopupLeft").value;}if(GetE("txtPopupTop").value.length>0){C+=",top="+GetE("txtPopupTop").value;}if(C!=""){C=C+",status";}return("window.open(this.href,"+D+",'"+C+"'); return false");}function FillPopupFields(B,E){if(B){GetE("txtPopupName").value=B;}var F=new Object();var A;while((A=oRegex.PopupFeatures.exec(E))!=null){var G=A[2];if(G==("yes"||"1")){F[A[1]]=true;}else{if(!isNaN(G)&&G!=0){F[A[1]]=G;}}}var D=document.getElementsByName("chkFeature");for(var C=0;C<D.length;C++){if(F[D[C].value]){D[C].checked=true;}}if(F.width){GetE("txtPopupWidth").value=F.width;}if(F.height){GetE("txtPopupHeight").value=F.height;}if(F.left){GetE("txtPopupLeft").value=F.left;}if(F.top){GetE("txtPopupTop").value=F.top;}}function Ok(){var A,H;oEditor.FCKUndo.SaveUndoStep();switch(GetE("cmbLinkType").value){case"url":A=GetE("txtUrl").value;if(A.length==0){alert(FCKLang.DlnLnkMsgNoUrl);return false;}A=GetE("cmbLinkProtocol").value+A;break;case"email":A=GetE("txtEMailAddress").value;if(A.length==0){alert(FCKLang.DlnLnkMsgNoEMail);return false;}A=oParser.CreateEMailUri(A,GetE("txtEMailSubject").value,GetE("txtEMailBody").value);break;case"anchor":var J=GetE("cmbAnchorName").value;if(J.length==0){J=GetE("cmbAnchorId").value;}if(J.length==0){alert(FCKLang.DlnLnkMsgNoAnchor);return false;}A="#"+J;break;}var F=oLink?[oLink]:oEditor.FCK.CreateLink(A,true);var C=(F.length>0);if(!C){H=A;switch(GetE("cmbLinkType").value){case"anchor":H=H.replace(/^#/,"");break;case"url":var E=new RegExp("//?([^?\"']+)([?].*)?$");var G=E.exec(A);if(G!=null){H=G[1];}break;case"email":H=GetE("txtEMailAddress").value;break;}F=[oEditor.FCK.InsertElement("a")];}for(var D=0;D<F.length;D++){oLink=F[D];if(C){H=oLink.innerHTML;}oLink.href=A;SetAttribute(oLink,"_fcksavedurl",A);var I;if(GetE("cmbTarget").value=="popup"){I=BuildOnClickPopup();I=encodeURIComponent(' onclick="'+I+'"');SetAttribute(oLink,"onclick_fckprotectedatt",I);}else{I=oLink.getAttribute("onclick_fckprotectedatt");if(I){I=decodeURIComponent(I);if(oRegex.OnClickPopup.test(I)){SetAttribute(oLink,"onclick_fckprotectedatt","");}}}oLink.innerHTML=H;if(GetE("cmbTarget").value!="popup"){SetAttribute(oLink,"target",GetE("txtTargetFrame").value);}else{SetAttribute(oLink,"target",null);}if(D==0){SetAttribute(oLink,"id",GetE("txtAttId").value);}SetAttribute(oLink,"name",GetE("txtAttName").value);SetAttribute(oLink,"dir",GetE("cmbAttLangDir").value);SetAttribute(oLink,"lang",GetE("txtAttLangCode").value);SetAttribute(oLink,"accesskey",GetE("txtAttAccessKey").value);SetAttribute(oLink,"tabindex",(GetE("txtAttTabIndex").value>0?GetE("txtAttTabIndex").value:null));SetAttribute(oLink,"title",GetE("txtAttTitle").value);SetAttribute(oLink,"type",GetE("txtAttContentType").value);SetAttribute(oLink,"charset",GetE("txtAttCharSet").value);if(oEditor.FCKBrowserInfo.IsIE){var B=GetE("txtAttClasses").value;if(GetE("txtAttName").value.length!=0){B+=" FCK__AnchorC";}SetAttribute(oLink,"className",B);oLink.style.cssText=GetE("txtAttStyle").value;}else{SetAttribute(oLink,"class",GetE("txtAttClasses").value);SetAttribute(oLink,"style",GetE("txtAttStyle").value);}}dialog.Selection.EnsureSelection();oEditor.FCKSelection.SelectNode(F[0]);return true;}function BrowseServer(){OpenFileBrowser(FCKConfig.LinkBrowserURL,FCKConfig.LinkBrowserWindowWidth,FCKConfig.LinkBrowserWindowHeight);}function SetUrl(A){document.getElementById("txtUrl").value=A;OnUrlChange();dialog.SetSelectedTab("Info");}function OnUploadCompleted(C,A,D,B){switch(C){case 0:alert("Your file has been successfully uploaded");break;case 1:alert(B);return ;case 101:alert(B);break;case 201:alert('A file with the same name is already available. The uploaded file has been renamed to "'+D+'"');break;case 202:alert("Invalid file type");return ;case 203:alert("Security error. You probably don't have enough permissions to upload. Please check your server.");return ;case 500:alert("The connector is disabled");break;default:alert("Error on file upload. Error number: "+C);return ;}SetUrl(A);GetE("frmUpload").reset();}var oUploadAllowedExtRegex=new RegExp(FCKConfig.LinkUploadAllowedExtensions,"i");var oUploadDeniedExtRegex=new RegExp(FCKConfig.LinkUploadDeniedExtensions,"i");function CheckUpload(){var A=GetE("txtUploadFile").value;if(A.length==0){alert("Please select a file to upload");return false;}if((FCKConfig.LinkUploadAllowedExtensions.length>0&&!oUploadAllowedExtRegex.test(A))||(FCKConfig.LinkUploadDeniedExtensions.length>0&&oUploadDeniedExtRegex.test(A))){OnUploadCompleted(202);return false;}return true;}function SetDefaultTarget(){var A=FCKConfig.DefaultLinkTarget||"";if(oLink||A.length==0){return ;}switch(A){case"_blank":case"_self":case"_parent":case"_top":GetE("cmbTarget").value=A;break;default:GetE("cmbTarget").value="frame";break;}GetE("txtTargetFrame").value=A;}