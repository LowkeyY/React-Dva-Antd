Ext.ns("lib.file.ddupload");lib.file.ddupload.DragDropUpload=function(el,config){config=config||{};this.initialConfig=config;Ext.apply(this,config);this.addEvents("beforedrop","uploadcomplete","error");this.el=Ext.get(el);Ext.EventManager.addListener(this.el,"dragenter",function(e){e.stopEvent();});Ext.EventManager.addListener(this.el,"dragover",function(e){e.stopEvent();});Ext.EventManager.addListener(this.el,"drop",this.onDrop,this);if(!this.progressBar){this.progressBar=lib.file.ddupload.ProgressBar;}};Ext.extend(lib.file.ddupload.DragDropUpload,Ext.util.Observable,{fileFieldName:"file-upload",uploading:false,files:[],onUploadFinish:function(success,message){this.progressBar.hide();if(success){this.fireEvent("uploadcomplete",this);}else{if(this.fireEvent("error",scope,message)!=false){Ext.msg("error",message);}}this.uploading=false;this.files=[];},uploadFile:function(){if(this.files.length==0){this.onUploadFinish(true);return ;}var file=this.files.shift();this.progressBar.setFile(file);this.sendFile(file,this.createFormData(file));},onDestroy:function(){this.progressBar.destroy();this.xhr=null;this.files=null;},createFormData:function(file){var formData=new FormData();formData.append(this.fileFieldName,file);if(Ext.isObject(this.params)){for(var name in this.params){formData.append(name,this.params[name]);}}return formData;},onDrop:function(e){e.stopEvent();var files=e.browserEvent.dataTransfer.files;if(this.fireEvent("beforedrop",this,files,e)==false){return ;}if(this.uploading===true){return ;}this.uploading=true;var total=0;var fileArr=[];for(var i=0;i<files.length;i++){var file=files[i];if(this.typeReg){if(!file.type.match(this.typeReg)){if(this.typeRegText){this.onUploadFinish(false,this.typeRegText);}else{continue;}}}fileArr.push(file);total+=file.size;}this.progressBar.show(total);this.files=fileArr;this.uploadFile();},getXHR:function(){if(!this.xhr){var xhr=new XMLHttpRequest();var scope=this;xhr.onreadystatechange=function(){if(xhr.readyState==4){scope.progressBar.add();var st=xhr.status;if(st>199&&st<300){var strValue=xhr.responseText;if(strValue){var json=Ext.decode(strValue);if(json.success){scope.uploadFile();}else{scope.onUploadFinish(false,json.message);}}else{scope.uploadFile();}}else{scope.onUploadFinish(false,CPM?CPM.getResponeseErrMsg(xhr):st);}}};Ext.EventManager.addListener(xhr.upload,"progress",function(e){var bytes=e.browserEvent.loaded;this.progressBar.add(bytes);},this);this.xhr=xhr;}return this.xhr;},sendFile:function(file,content){var xhr=this.getXHR();xhr.open("post",this.url,true);if(Ext.isChrome){xhr.send(content);}else{xhr.sendAsBinary(content);}}});lib.file.ddupload.ProgressBar={visible:false,timer:false,fileSize:0,base:0,fileName:"",total:0,cur:0,msg:null,show:function(total){this.total=total;this.timer=this.showRealBar.defer(300,this);},showRealBar:function(){this.visible=true;this.msg=Ext.MessageBox.progress("上传文件","正在上传文件:"+this.fileName);this.msg.updateProgress(this.cur/this.total);},setFile:function(file){if(this.fileSize>0){this.base=this.base+this.fileSize;}this.fileSize=file.size;this.fileName=file.name;if(this.visible){this.msg.updateText("正在上传文件:"+this.fileName);}},add:function(bytes){bytes=bytes?bytes*0.9:this.fileSize;if(this.visible){this.msg.updateProgress((this.base+bytes)/this.total);}else{this.cur=this.base+bytes;}},destroy:function(){this.msg=null;},hide:function(){if(this.visible){this.msg.hide();this.msg=null;}else{clearTimeout(this.timer);}this.visible=false;this.fileSize=0;this.cur=0;this.total=0;this.base=0;}};