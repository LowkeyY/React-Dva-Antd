Ext.namespace("utils.km.portal");utils.km.portal.PublishPanel=function(B,A){this.frames=B;this.ButtonArray=[];this.ButtonArray.push(new Ext.Toolbar.Button({btnId:"back",text:"返回".loc(),icon:"/themes/icon/common/redo.gif",cls:"x-btn-text-icon  bmenu",disabled:false,hidden:true,scope:this,state:"create",handler:this.onButtonClick}));this.ButtonArray.push(new Ext.Toolbar.Button({btnId:"save",text:"保存".loc(),icon:"/themes/icon/common/save.gif",cls:"x-btn-text-icon  bmenu",disabled:false,hidden:true,scope:this,state:"create",handler:this.onButtonClick}));this.ButtonArray.push(new Ext.Toolbar.Button({btnId:"clear",text:"清空".loc(),icon:"/themes/icon/xp/clear.gif",cls:"x-btn-text-icon  bmenu",disabled:false,scope:this,hidden:true,state:"create",handler:this.onButtonClick}));this.ButtonArray.push(new Ext.Toolbar.Button({btnId:"updatesave",text:"保存".loc(),icon:"/themes/icon/common/save.gif",cls:"x-btn-text-icon  bmenu",disabled:false,scope:this,hidden:true,state:"edit",handler:this.onButtonClick}));this.ButtonArray.push(new Ext.Toolbar.Button({btnId:"del",text:"删除".loc(),icon:"/themes/icon/common/delete.gif",cls:"x-btn-text-icon  bmenu",disabled:false,scope:this,hidden:true,state:"edit",handler:this.onButtonClick}));this.publishForm=new Ext.FormPanel({border:false,labelWidth:100,labelAlign:"right",url:"/utils/km/portal/publish.jcp",id:"publishBase",cached:true,method:"POST",border:false,bodyStyle:"padding:20px 15px 30px 0px;height:100%;width:100%;background:#FFFFFF;",items:[{layout:"column",border:false,items:[{columnWidth:1,layout:"form",border:false,items:[new Ext.form.TextField({fieldLabel:"标题".loc(),name:"page_title",width:150,maxLength:64,allowBlank:false,maxLengthText:"页面标题{0}个字符!".loc(),blankText:"页面标题必须提供.".loc()})]}]},{layout:"column",border:false,items:[{columnWidth:1,layout:"form",border:false,items:[{xtype:"radiogroup",fieldLabel:"节点链接页面".loc(),hiddenName:"first_page",width:80,items:[{boxLabel:"是".loc(),name:"first_page",inputValue:"y",checked:true},{boxLabel:"否".loc(),name:"first_page",inputValue:"n"}]}]}]},{layout:"column",border:false,items:[{columnWidth:1,layout:"form",border:false,items:[new Ext.form.TextArea({fieldLabel:"页面说明".loc(),name:"comment",width:550,height:60,maxLength:500,maxLengthText:"系统说明不能超过{0}个字符!".loc()})]}]}],tbar:this.ButtonArray});this.formDS=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:"/utils/km/portal/publish.jcp",method:"GET"}),reader:new Ext.data.JsonReader({},["pageId","parent_id","page_title","comment","first_page"]),remoteSort:false});this.MainTabPanel=this.publishForm;};utils.km.portal.PublishPanel.prototype={formCreate:function(A){this.toggleToolBar("create");this.formDS.baseParams=A;this.formDS.baseParams.type="new";this.frames.get("Portal").mainPanel.setStatusValue(["页面管理".loc()]);},formEdit:function(){this.toggleToolBar("edit");},loadData:function(A){this.formDS.baseParams=A;this.formDS.on("load",this.renderForm,this);this.formDS.load({params:{start:0,limit:1}});},toggleToolBar:function(B){var A=this.publishForm.getTopToolbar();A.items.each(function(C){C.hide();},A.items);A.items.each(function(C){if(C.state==B){C.show();}},A.items);},renderForm:function(){var B=this.publishForm.form,C=this.formDS.getAt(0).data;for(var A=0;A<this.ButtonArray.length;A++){if(this.ButtonArray[A].btnId=="del"){this.ButtonArray[A].setDisabled(this.formDS.baseParams.son!="0");}}B.findField("page_title").setValue(C.page_title);B.findField("comment").setValue(C.comment);B.findField("first_page").setValue(C.first_page);this.frames.get("Portal").mainPanel.setStatusValue(["页面管理".loc(),C.pageId,"无","无"]);},onButtonClick:function(I){var D=this.frames.get("Portal");var H=this.publishForm.form;if(I.btnId=="new"){var B=this.formDS.baseParams;B.type="new";this.formCreate(B);H.reset();}else{if(I.btnId=="back"){var F=this.formDS.baseParams.prgType;var C=this.formDS.baseParams;D.mainPanel.setActiveTab("portalBase");D.menu.formEdit();C.type=null;D.menu.loadData(C);}else{if(I.btnId=="save"){var A=this.formDS.baseParams;A.type="save";A.first_page=this.publishForm.form.findField("first_page").inputValue;if(H.isValid()){H.submit({url:"/utils/km/portal/publish.jcp",params:A,method:"POST",scope:this,success:function(J,K){Ext.msg("info","保存成功!".loc());D.navPanel.getTree().loadSubNode(K.result.id,D.navPanel.clickEvent);},failure:function(J,K){Ext.msg("error","数据提交失败!,原因:".loc()+"<br>"+K.result.message);}});}else{Ext.msg("error","数据不能提交,请修改表单中标识的错误!".loc());}}else{if(I.btnId=="clear"){try{this.publishForm.form.reset();}catch(E){}}else{if(I.btnId=="del"){Ext.msg("confirm","确认删除?".loc(),function(J){if(J=="yes"){var K=this.formDS.baseParams;K.type="delete";this.publishForm.form.submit({url:"/utils/km/portal/publish.jcp",params:K,method:"POST",scope:this,success:function(L,M){D.navPanel.getTree().loadParentNode(D.navPanel.clickEvent);},failure:function(L,M){Ext.msg("error","数据删除失败!,原因:".loc()+"<br>"+M.result.message);}});}}.createDelegate(this));}else{if(I.btnId=="updatesave"){if(H.isValid()){var G=this.formDS.baseParams;G.type="updatesave";G.first_page=this.publishForm.form.findField("first_page").inputValue;H.submit({url:"/utils/km/portal/publish.jcp",params:G,method:"POST",scope:this,success:function(J,K){D.navPanel.getTree().loadSelfNode(K.result.id,D.navPanel.clickEvent);Ext.msg("info","数据更新完毕!".loc());},failure:function(J,K){Ext.msg("error","数据提交失败,原因:".loc()+"<br>"+K.result.message);}});}else{Ext.msg("error","数据不能提交,请修改表单中标识的错误!".loc());}}}}}}}}};