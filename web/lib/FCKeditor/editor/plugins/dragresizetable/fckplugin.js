var FCKDragTableHandler={_DragState:0,_LeftCell:null,_RightCell:null,_MouseMoveMode:0,_ResizeBar:null,_OriginalX:null,_MinimumX:null,_MaximumX:null,_LastX:null,_TableMap:null,_doc:document,_IsInsideNode:function(B,D,H){var F=FCKTools.GetWindowPosition(B,D);var C=F.x;var A=F.y;var G=parseInt(C,10)+parseInt(D.offsetWidth,10);var E=parseInt(A,10)+parseInt(D.offsetHeight,10);if(H.x>=C&&H.x<=G&&H.y>=A&&H.y<=E){return true;}return false;},_GetBorderCells:function(J,S,N,K){var E=[];for(var Q=0;Q<S.rows.length;Q++){var O=S.rows[Q];for(var P=0;P<O.cells.length;P++){E.push(O.cells[P]);}}if(E.length<1){return null;}var C=null;var D=null;var I=null;var R=null;var A=null;for(var Q=0;Q<E.length;Q++){var G=FCKTools.GetWindowPosition(J,E[Q]);var F=G.x+parseInt(E[Q].clientWidth,10);var T=K.x-F;var M=K.y-(G.y+(E[Q].clientHeight/2));if(C==null||(Math.abs(T)<=Math.abs(C)&&(I==null||Math.abs(M)<=Math.abs(I)))){C=T;I=M;R=E[Q];}}var B=R.parentNode.rowIndex;var L=FCKTableHandler._GetCellIndexSpan(N,B,R);var H=isNaN(R.colSpan)?1:R.colSpan;A=N[B][L+H];if(!A){return null;}D=K.x-FCKTools.GetWindowPosition(J,A).x;if(D<0&&C<0&&C<-2){return null;}if(D>0&&C>0&&D>3){return null;}return{leftCell:R,rightCell:A};},_GetResizeBarPosition:function(){var A=FCKTools.GetElementAscensor(this._RightCell,"tr");return FCKTableHandler._GetCellIndexSpan(this._TableMap,A.rowIndex,this._RightCell);},_ResizeBarMouseDownListener:function(L){if(!L){L=window.event;}if(FCKDragTableHandler._LeftCell){FCKDragTableHandler._MouseMoveMode=1;}if(FCKBrowserInfo.IsIE){FCKDragTableHandler._ResizeBar.filters.item("DXImageTransform.Microsoft.Alpha").opacity=50;}else{FCKDragTableHandler._ResizeBar.style.opacity=0.5;}FCKDragTableHandler._OriginalX=L.clientX;var J=FCKDragTableHandler._GetResizeBarPosition();var F=FCKDragTableHandler._GetIframeOffset();var M=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var D=null;var C=null;for(var A=0;A<FCKDragTableHandler._TableMap.length;A++){var K=FCKDragTableHandler._TableMap[A][J-1];var G=FCKDragTableHandler._TableMap[A][J];var I=FCKTools.GetWindowPosition(FCK.EditorWindow,K);var H=FCKTools.GetWindowPosition(FCK.EditorWindow,G);var B=FCKDragTableHandler._GetCellPadding(M,K);var E=FCKDragTableHandler._GetCellPadding(M,G);if(D==null||I.x+B>D){D=I.x+B;}if(C==null||H.x+G.clientWidth-E<C){C=H.x+G.clientWidth-E;}}FCKDragTableHandler._MinimumX=D+F.x;FCKDragTableHandler._MaximumX=C+F.x;FCKDragTableHandler._LastX=null;},_ResizeBarMouseUpListener:function(K){if(!K){K=window.event;}FCKDragTableHandler._MouseMoveMode=0;FCKDragTableHandler._HideResizeBar();if(FCKDragTableHandler._LastX==null){return ;}var E=FCKDragTableHandler._LastX-FCKDragTableHandler._OriginalX;var O=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var N=[];var C=FCKDragTableHandler._TableMap;for(var H=0;H<C.length;H++){for(var D=0;D<C[H].length;D++){var L=C[H][D];var B=FCKDragTableHandler._GetCellWidth(O,L);var I=isNaN(L.colSpan)?1:L.colSpan;if(N.length<=D){N.push({width:B/I,colSpan:I});}else{var M=N[D];if(M.colSpan>I){M.width=B/I;M.colSpan=I;}}}}colIndex=FCKDragTableHandler._GetResizeBarPosition();colIndex--;N[colIndex].width+=E;N[colIndex+1].width-=E;for(var A=0;A<O.rows.length;A++){var P=O.rows.item(A);for(var J=0;J<P.cells.length;J++){var L=P.cells.item(J);L.width="";L.style.width="";}}var G=O.getElementsByTagName("col");for(var H=G.length-1;H>=0;H--){G[H].parentNode.removeChild(G[H]);}var F=[];for(var H=0;H<C.length;H++){for(var D=0;D<C[H].length;D++){var L=C[H][D];if(L._Processed){continue;}if(C[H][D-1]!=L){L.width=N[D].width;}else{L.width=parseInt(L.width,10)+parseInt(N[D].width,10);}if(C[H][D+1]!=L){F.push(L);L._Processed=true;}}}for(var H=0;H<F.length;H++){if(FCKBrowserInfo.IsIE){F[H].removeAttribute("_Processed");}else{delete F[H]._Processed;}}FCKDragTableHandler._LastX=null;},_ResizeBarMouseMoveListener:function(A){if(!A){A=window.event;}if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(FCK,A);}else{return FCKDragTableHandler._MouseDragHandler(FCK,A);}},_GetCellPadding:function(E,B){var A=parseInt(E.cellPadding,10)*2;var C=null;if(typeof (window.getComputedStyle)=="function"){var F=window.getComputedStyle(B,null);C=parseInt(F.getPropertyValue("padding-left"),10)+parseInt(F.getPropertyValue("padding-right"),10);}else{C=parseInt(B.currentStyle.paddingLeft,10)+parseInt(B.currentStyle.paddingRight,10);}var D=B.style.padding;if(isFinite(D)){C=parseInt(D,10)*2;}else{D=B.style.paddingLeft;if(isFinite(D)){C=parseInt(D,10);}D=B.style.paddingRight;if(isFinite(D)){C+=parseInt(D,10);}}A=parseInt(A,10);C=parseInt(C,10);if(isNaN(A)){A=0;}if(isNaN(C)){C=0;}return Math.max(A,C);},_GetCellWidth:function(B,A){var C=A.clientWidth;if(isNaN(C)){C=0;}return C-this._GetCellPadding(B,A);},MouseMoveListener:function(B,A){if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(B,A);}else{return FCKDragTableHandler._MouseDragHandler(B,A);}},_MouseFindHandler:function(L,N){if(L.MouseDownFlag){return ;}var D=N.srcElement||N.target;try{if(!D||D.nodeType!=1){this._HideResizeBar();return ;}}catch(K){this._HideResizeBar();return ;}var F=N.clientX;var E=N.clientY;if(FCKTools.GetElementDocument(D)==document){var H=this._GetIframeOffset();F-=H.x;E-=H.y;}if(this._ResizeBar&&this._LeftCell){var G=FCKTools.GetWindowPosition(L.EditorWindow,this._LeftCell);var J=FCKTools.GetWindowPosition(L.EditorWindow,this._RightCell);var I=F-(G.x+this._LeftCell.clientWidth);var M=F-J.x;var C=false;if(M>=0&&I<=0){C=true;}else{if(I>0&&M<=3){C=true;}else{if(M<0&&I>=-2){C=true;}}}if(C){this._ShowResizeBar(L.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{x:F,y:E});return ;}}var B=D.tagName.toLowerCase();if(B!="table"&&B!="td"&&B!="th"){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();return ;}D=FCKTools.GetElementAscensor(D,"table");var A=FCKTableHandler._CreateTableMap(D);var O=this._GetBorderCells(L.EditorWindow,D,A,{x:F,y:E});if(O==null){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();}else{this._LeftCell=O.leftCell;this._RightCell=O.rightCell;this._TableMap=A;this._ShowResizeBar(L.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{x:F,y:E});}},_MouseDragHandler:function(F,A){var C={x:A.clientX,y:A.clientY};var D=A.srcElement||A.target;if(FCKTools.GetElementDocument(D)==F.EditorDocument){var E=this._GetIframeOffset();C.x+=E.x;C.y+=E.y;}if(C.x>=this._MaximumX-5){C.x=this._MaximumX-5;}if(C.x<=this._MinimumX+5){C.x=this._MinimumX+5;}var B=C.x+FCKTools.GetScrollPosition(window).X;this._ResizeBar.style.left=(B-this._ResizeBar.offsetWidth/2)+"px";this._LastX=C.x;},_ShowResizeBar:function(K,N,G){if(this._ResizeBar==null){this._ResizeBar=this._doc.createElement("div");var J=this._ResizeBar;var B={position:"absolute",cursor:"e-resize"};if(FCKBrowserInfo.IsIE){B.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=10,enabled=true)";}else{B.opacity=0.1;}FCKDomTools.SetElementStyles(J,B);this._avoidStyles(J);J.setAttribute("_fcktemp",true);this._doc.body.appendChild(J);FCKTools.AddEventListener(J,"mousemove",this._ResizeBarMouseMoveListener);FCKTools.AddEventListener(J,"mousedown",this._ResizeBarMouseDownListener);FCKTools.AddEventListener(document,"mouseup",this._ResizeBarMouseUpListener);FCKTools.AddEventListener(FCK.EditorDocument,"mouseup",this._ResizeBarMouseUpListener);var D=this._doc.createElement("img");D.setAttribute("_fcktemp",true);D.border=0;D.src=FCKConfig.BasePath+"images/spacer.gif";D.style.position="absolute";J.appendChild(D);var E=function(P){if(!P){P=window.event;}if(P.preventDefault){P.preventDefault();}else{P.returnValue=false;}};FCKTools.AddEventListener(D,"dragstart",E);FCKTools.AddEventListener(D,"selectstart",E);}var J=this._ResizeBar;var C=this._GetIframeOffset();var L=this._GetTablePosition(K,N);var M=N.offsetHeight;var H=C.y+L.y;if(L.y<0){M+=L.y;H-=L.y;}var I=parseInt(N.border,10);if(isNaN(I)){I=0;}var F=parseInt(N.cellSpacing,10);if(isNaN(F)){F=0;}var O=Math.max(I+100,F+100);var B={top:H+"px",height:M+"px",width:O+"px",left:(C.x+G.x+FCKTools.GetScrollPosition(K).X-O/2)+"px"};if(FCKBrowserInfo.IsIE){J.filters.item("DXImageTransform.Microsoft.Alpha").opacity=10;}else{B.opacity=0.1;}FCKDomTools.SetElementStyles(J,B);var D=J.getElementsByTagName("img")[0];FCKDomTools.SetElementStyles(D,{width:J.offsetWidth+"px",height:M+"px"});O=Math.max(I,F,3);var A=null;if(J.getElementsByTagName("div").length<1){A=this._doc.createElement("div");this._avoidStyles(A);A.setAttribute("_fcktemp",true);J.appendChild(A);}else{A=J.getElementsByTagName("div")[0];}FCKDomTools.SetElementStyles(A,{position:"absolute",backgroundColor:"blue",width:O+"px",height:M+"px",left:"50px",top:"0px"});},_HideResizeBar:function(){if(this._ResizeBar){FCKDomTools.SetElementStyles(this._ResizeBar,{top:"-100000px",left:"-100000px"});}},_GetIframeOffset:function(){return FCKTools.GetDocumentPosition(window,FCK.EditingArea.IFrame);},_GetTablePosition:function(A,B){return FCKTools.GetWindowPosition(A,B);},_avoidStyles:function(A){FCKDomTools.SetElementStyles(A,{padding:"0",backgroundImage:"none",border:"0"});}};FCK.Events.AttachEvent("OnMouseMove",FCKDragTableHandler.MouseMoveListener);