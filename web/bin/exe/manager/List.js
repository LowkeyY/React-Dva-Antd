using("bin.exe.filter.RangeMenu");using("bin.exe.filter.ListMenu");using("bin.exe.filter.EditableItem");using("bin.exe.filter.Filter");using("bin.exe.filter.BooleanFilter");using("bin.exe.filter.DateFilter");using("bin.exe.filter.ListFilter");using("bin.exe.filter.NumericFilter");using("bin.exe.filter.StringFilter");using("bin.exe.filter.CalendarFilter");using("bin.exe.filter.DictFilter");using("bin.exe.filter.CombotreeFilter");using("bin.exe.filter.WidgetFilter");using("bin.exe.filter.GridFilters");using("bin.exe.UnitPlugin");using("bin.exe.PureArrayReader");CPM.manager.List=Ext.extend(CPM.manager.CustomizeObject,{className:"CPM.manager.List",updateData:function(A,D){var B=A.getStore();var C=B.getSortState();if(C!=null){Ext.apply(D,{sort:C.field,dir:C.direction});}if(B.baseParams.unit_tz_plugin){D.unit_tz_plugin=B.baseParams.unit_tz_plugin;}A.param=D;this.getData("data",D,this.loadResult.createCallBackWithArgs([A,D]),A);if(A.filters){A.filters.clearFilters();}Ext.apply(B.baseParams,{objectId:D.objectId,exportData:D.exportData});},loadResult:function(A,C,B,G){if(Ext.isDefined(A.disabledButton)){var F=","+A.disabledButton;this.getTopToolbar().items.each(function(H){H.setDisabled((H.text&&F.indexOf(","+H.text+",")!=-1));});}if(Ext.isDefined(A.callback)){var E=A.callback;if(Ext.isFunction(E)){E.call(this,A.callbackParam);}delete A.callback;delete A.callbackParam;}this.getStore().loadData(A);if(Ext.isObject(G)){var D=this.getStore();D.fireEvent("load",D,D.getRange(),{params:G});}this.el.unmask();},load:function(C,A,B){this.getData(C,B,function(D,G){var E;if(C.indexOf("model")!=-1){CPM.addModel(B.objectId,G);E=this.createModel(A,D,B);E.loadResult(D,null,E,B);E.param=B;}else{if(B.moduleReady==false){B.moduleReady=(function(H,I){I.loadResult(H,null,I,I.param);}).createCallBackWithArgs(D);}else{var F=B.moduleReady.getStore();B.moduleReady.loadResult(D,null,B.moduleReady,B);delete B.moduleReady;}}}.createDelegate(this));},createModel:function(M,N,E,D){if(M.ownerCt.xtype=="tabpanel"&&N.title){M.setTitle(N.title);}if(!N.sortInfo&&E.dir){N.sortInfo={field:E.sort,direction:E.dir};}var L=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:CPM.action,method:"GET"}),sortInfo:N.sortInfo,reader:new bin.exe.PureArrayReader({},Ext.data.Record.create(N.fields)),baseParams:Ext.applyIf({DataPartMode:"data"},E),sort:function(P,O){if(this.lastOptions){if(!this.lastOptions.params){this.lastOptions.params={};}this.lastOptions.params.DataPartMode="puredata";}return this.singleSort(P,O);},autoLoad:false,remoteSort:true});var B=Ext.id();var G=[];var C=Ext.isDefined(N.filters)&&!Ext.isDefined(N.searchEditor);if(C){N.filters=new Ext.grid.GridFilters({filters:N.filters});G.push(N.filters);}var K=new Ext.PagingToolbar({store:L,plugins:G,displayInfo:true,pageSize:N.PageSize,displayMsg:"{0}-{1}条 共:{2}条".loc(),emptyMsg:"没有数据".loc()});K.on("beforechange",function(O,P){P.DataPartMode="puredata";});var A={xtype:"grid",cm:this.createColumnModel(N),border:false,stripeRows:true,store:L,id:B,exportInfo:N.exportInfo,head:false,plugins:G,objectId:E.objectId,height:250,loadMask:true,iconCls:"icon-grid",programType:E.programType,loadResult:this.loadResult,listeners:{rowdblclick:function(P,U,S){var O=P.getColumnModel().target;if(typeof (O)=="undefined"){return false;}var T=P.getStore().getAt(U);var Q=CPM.getModule(P.param.programType);var R=Q.getExportParams(P,T,{pData:T.get("pmk"),dataId:T.get("pmk"),pageType:"view",programType:"ProgramInput"});var R=Ext.applyIf(R,P.param);if(typeof (R.sort)!="undefined"){delete R.dir;delete R.sort;}CPM.replaceTarget(P,P.ownerCt,R,O);}},bbar:K};if(Ext.isDefined(N.events)){if(Ext.isFunction(N.events.beforeinit)){if(N.events.beforeinit.call(this,A,N,E,M)===false){return ;}delete N.events.beforeinit;}Ext.apply(A.listeners,N.events);}if(C){A.filters=N.filters;delete N.filters;}if(N.gridGroupHead){using("lib.GroupHeaderGrid.GroupHeaderGrid");A.plugins.push(new lib.GroupHeaderGrid.GroupHeaderGrid({rows:N.gridGroupHead,hierarchicalColMenu:true}));}if(N.haveUnit){var J=new Array();Ext.each(N.cm,function(O){if(O.unit){J.push(O);}});var I=new bin.exe.UnitPlugin(J);A.plugins.push(I);}if(typeof (N.autoExpandColumn)!="undefined"){A.autoExpandColumn=N.autoExpandColumn;}if(typeof (D)!="undefined"){Ext.apply(A,D);}if(Ext.isArray(N.buttonArray)){var H=new Array(),F=null;Ext.each(N.buttonArray,function(O){F=this.getButton(O,B);H.push((F==null)?O:F);},this);if(H.length>0){if(Ext.isDefined(N.disabledButton)){Ext.each(H,function(O){if(N.disabledButton.indexOf(","+O.text+",")!=-1){O.disabled=true;}});}A.tbar={xtype:"toolbar",enableOverflow:true,items:H};}}if(Ext.isDefined(N.searchEditor)){this.appendSearchEditor(A,N,E);}if(N.showHelpButton){CPM.Help.addHelpButton(A,E);}A=this.adjustPanel(A,E,N);A=M.add(A);if(N.logHistroy===true){A.on("beforedestroy",function(O){CPM.History.add(this.getState());CPM.History.addFunction(M);},this);}M.doLayout();A=this.fixPanel(A,E,N);return A;},adjustPanel:function(A,C,B){return A;},fixPanel:function(A,C,B){A.el.mask(Ext.LoadMask.prototype.msg);return A;},canUpdateDataOnly:function(B,A,C){return(typeof (B)!="undefined")&&B.objectId==C.objectId&&!C.forceToRebuild;},createColumnModel:function(json){Ext.each(json.cm,function(item){if(Ext.isString(item.renderer)){item.renderer=eval(item.renderer);}});return new Ext.grid.ColumnModel(json.cm);},appendSearchEditor:function(panel,json,param){var arr=Ext.isDefined(panel.tbar)?panel.tbar.items:[];arr.push("->");if(Ext.isDefined(json.searchEditor.libs)){eval(json.searchEditor.libs);}var editors=json.searchEditor.editors;if(param.filter){var f=Ext.decode(param.filter);for(var i=0;i<editors.length;i++){if(Ext.isDefined(f[editors[i].xtitleList])){editors[i].value=f[editors[i].xtitleList];}}}for(var i=0;i<editors.length;i++){arr.push(editors[i]);arr.push(" ");}arr.push(new Ext.Toolbar.Button({text:"查询".loc(),panelId:panel.id,icon:"/themes/icon/xp/selectlink.gif",cls:"x-btn-text-icon bmenu",handler:function(btn){var cbk=function(){var result={};var eds=[];var panel=Ext.getCmp(btn.panelId);panel.getEl().mask("数据载入中".loc(),"x-mask-loading");panel.getTopToolbar().items.each(function(item){if(Ext.isDefined(item.xtitleList)){eds.push(item);}});var store=panel.getStore();for(var i=0;i<eds.length;i++){if(!eds[i].validate()){panel.getEl().unmask();Ext.msg("error","请改正标示出的错误.".loc());return false;}var v=eds[i].getValue();if(v instanceof Date){v=v.format(eds[i].format);}result[eds[i].xtitleList]=v;}if(Ext.isDefined(panel.beforeFilter)){if(panel.beforeFilter(panel,eds,result)===false){panel.getEl().unmask();return ;}}Ext.apply(store.baseParams,{meta:false,filter:Ext.encode(result)});store.load({params:{start:0,limit:panel.pageSize},scope:this,callback:function(){panel.getEl().unmask();}});};cbk.defer(30,this);}}));arr.push(new Ext.Toolbar.Button({text:"还原".loc(),scope:this,panelId:panel.id,icon:"/themes/icon/all/magifier_zoom_out.gif",cls:"x-btn-text-icon bmenu",handler:function(btn){var panel=Ext.getCmp(btn.panelId);var eds=[];panel.getTopToolbar().items.each(function(item){if(Ext.isDefined(item.xtitleList)){eds.push(item);}});for(var i=0;i<eds.length;i++){eds[i].reset();for(var j=0;j<editors.length;j++){if(eds[i].xtitleList==editors[j].xtitleList){eds[i].setValue(editors[j].value);}}}if(Ext.isDefined(panel.beforeFilterReset)){if(panel.beforeFilterReset(panel,eds,result)===false){return ;}}var store=panel.getStore();Ext.apply(store.baseParams,{meta:false,filter:"{}"});store.load({params:{start:0,limit:panel.pageSize}});}}));panel.tbar=arr;delete json.searchEditor;},getExportParams:function(B,A,C){var D=B.exportInfo;var E=D.indexOf(",");return Ext.apply({pTab:D.substring(0,E),pItem:D.substring(E+1)},C);},buttonMap:{"%new":{handler:function(B){var A=Ext.getCmp(B.panelId);CPM.replaceTarget(A,A.ownerCt,A.param,B.target);}},"%edit":{handler:function(C){var A=Ext.getCmp(C.panelId);var E=A.getSelectionModel().getSelected();if(typeof (E)=="undefined"){if(A.getStore().getCount()==1){E=A.getStore().getAt(0);}else{Ext.msg("warn","请选择要编辑的行.".loc());return ;}}var B=CPM.getModule(A.param.programType);var D=B.getExportParams(A,E,{pData:E.get("pmk"),dataId:E.get("pmk")});var D=Ext.applyIf(D,A.param);CPM.replaceTarget(A,A.ownerCt,D,C.target);}},"%view":{handler:function(C){var A=Ext.getCmp(C.panelId);var E=A.getSelectionModel().getSelected();if(typeof (E)=="undefined"){Ext.msg("warn","请选择一行.".loc());return ;}var B=CPM.getModule(A.param.programType);var D=B.getExportParams(A,E,{pData:E.get("pmk"),dataId:E.get("pmk")});var D=Ext.applyIf(D,A.param);CPM.replaceTarget(A,A.ownerCt,D,C.target);}},"%copy":{handler:function(B){var A=Ext.getCmp(B.panelId);var D=A.getSelectionModel().getSelected();if(typeof (D)=="undefined"){Ext.msg("warn","请选择要复制的行.".loc());return ;}var C=Ext.applyIf({pageType:"copy",dataId:D.get("pmk")},A.param);CPM.replaceTarget(A,A.ownerCt,C,B.target);}},"%delete":{handler:function(C){var A=Ext.getCmp(C.panelId);var F=A.getSelectionModel().getSelections();if(F.length==0){Ext.msg("warn","请选择要删除的行.".loc());return ;}var E=A.param;var D=new Array();for(var B=0;B<F.length;B++){D.push(F[B].get("pmk"));}Ext.msg("confirm","确定删除选择的记录?".loc(),function(I){if(I=="yes"){var G=CPM.getModule(E.programType);var H={data:D.join(","),objectId:E.objectId,programType:G.programType};if(A instanceof Ext.grid.GridPanel){Ext.applyIf(H,A.getStore().baseParams);}CPM.doAction({params:H,method:"DELETE",success:function(J,K){if(Ext.isDefined(A.filters)){Ext.apply(E,A.filters.buildQuery(A.filters.getFilterData()));}G.updateData(A,H);if(C.target.targets){CPM.replaceTarget(A,A.ownerCt,E,C.target);}}},this);}}.createDelegate(this));}},"%batchupdate":{handler:function(D){var A=Ext.getCmp(D.panelId);var G=A.getSelectionModel().getSelections();if(G.length==0){Ext.msg("warn","请选择要更新的行.".loc());return ;}var F=new Array();for(var C=0;C<G.length;C++){F.push(G[C].get("pmk"));}var B=CPM.getModule(A.param.programType);var E=B.getExportParams(A,G,{pageType:"batchupdate",data:F.join(",")});var E=Ext.applyIf(E,A.param);Ext.msg("confirm","确定更新选择的记录?".loc(),function(K){if(K=="yes"){var H=D.target.targets;var I=0;for(var J=0;J<H.length;J++){if(H[J].programType=="ProgramBatchUpdate"){I=H[J].id;break;}}Ext.Ajax.request({url:"/bin/exe/batchupdate.jcp",params:{objectId:I,programType:"ProgramBatchUpdate"},method:"post",scope:this,success:function(O,P){var N=O.responseText;var M=Ext.util.JSON.decode(N);if(M.haveWindow){CPM.replaceTarget(A,A.ownerCt,E,D.target);}else{var L;var R=M.buttonArray;for(J=0;J<R.length;J++){if(R[J].action="%save"){L=R[J].target;break;}}var Q=CPM.getModule(E.programType);CPM.doAction({params:{data:F.join(","),objectId:E.objectId,batchObjectId:I,programType:Q.programType},method:"PUT",success:function(S,T){Q.updateData(A,E);if(L){CPM.replaceTarget(A,A.ownerCt,E,L);}}},this);}},failure:function(L,M){Ext.msg("error",CPM.getResponeseErrMsg(L));}});}}.createDelegate(this));}},"%audit":{handler:function(D){var A=Ext.getCmp(D.panelId);var G=A.getStore().getRange();if(G.length==0){Ext.msg("warn","请选择要删除的行.".loc());return ;}var F=A.param;var E=new Array();for(var C=0;C<G.length;C++){E.push(G[C].get("pmk"));}var B=CPM.getModule(F.programType);CPM.doAction({url:"/bin/workflow/apply.jcp?",params:{data:E.join(","),objectId:F.objectId,programType:B.programType},method:"POST",success:function(H,I){Ext.msg("info","申请提交成功".loc());B.updateData(A,F);if(D.target.targets){CPM.replaceTarget(A,A.ownerCt,F,D.target);}}},this);}},"%excel":{handler:function(A){try{var C=Ext.getCmp(A.panelId);var I=C.getColumnModel();var J=C.getStore();var D=[];var G=[];var H=[];for(var E=0;E<I.getColumnCount();E++){if(!I.isHidden(E)&&I.getColumnHeader(E)!=""){D.push(I.getColumnWidth(E));G.push(I.getColumnHeader(E));H.push(I.getDataIndex(E));}}var B=Ext.apply({widths:D.join(","),programType:C.param.programType,heads:G.join(","),index:H.join(",")},{limit:J.getTotalCount(),start:0},J.baseParams);if(Ext.isDefined(C.filters)){Ext.apply(B,C.filters.buildQuery(C.filters.getFilterData()));}var K=J.getSortState();if(K!=undefined){B.sort=K.field;B.dir=K.direction;}CPM.popWin("/bin/exe/downExcel.jcp?",B);}catch(F){Ext.msg("error",F);}}},"%download":{handler:function(B){var A=Ext.getCmp(B.panelId);var C={programType:A.param.programType,objectId:A.param.objectId};CPM.popWin("/bin/exe/downTemplate.jcp",C);}},"%upload":{handler:function(D){var C=Ext.getCmp(D.panelId);using("bin.exe.upLoadCsv");var E=350;var B=120;var A=new bin.exe.upLoadCsv(E,B,C);A.show();}},"%exceltemplate":{handler:function(B){var A=Ext.getCmp(B.panelId);CPM.popWin("/bin/exe/excelTemplate.jcp",A.param);}},"%excelupload":{handler:function(D){var C=Ext.getCmp(D.panelId);using("bin.exe.uploadExcel");var E=350;var B=120;var A=new bin.exe.uploadExcel(E,B,C);A.show();}},"%chart":{handler:function(B){var A=Ext.getCmp(this.formId);A.mgr.loadDefault();A.mgr.changeState("new");}},"%map":{handler:function(B){var A=Ext.getCmp(this.formId);A.mgr.loadDefault();A.mgr.changeState("new");}},"%updateFinish":{handler:function(B){var A=Ext.getCmp(B.panelId);var C={};Ext.apply(C,A.param);Ext.Ajax.request({url:"/bin/exe/updateErrorResult.jcp",params:C,method:"post",scope:this,success:function(D,E){A=A.findParentByType(Ext.Window);if(A){A.close();}},failure:function(D,E){Ext.msg("error",CPM.getResponeseErrMsg(D));}});}}},commands:{refresh:function(B,A){},empty:function(B,A){B.pageType="empty";}},getState:function(A,B){var C=B.store;if(C){var E=B.param;var D=C.getSortState();if(D){E=Ext.apply({sort:D.field,dir:D.direction},E);}if(C.baseParams.filter){E.filter=C.baseParams.filter;}var F=B.getBottomToolbar();if(F){E.start=F.cursor;E.limit=F.pageSize;}return{owner:A.id,programType:B.param.programType,params:Ext.encode(E)};}}});