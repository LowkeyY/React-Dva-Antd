Ext.namespace("lib.RowEditorGrid");lib.RowEditorGrid.RowEditorGrid=Ext.extend(Ext.grid.EditorGridPanel,{showDirtyMark:true,autoSave:true,needToRefreshFlag:0,initComponent:function(){lib.RowEditorGrid.RowEditorGrid.superclass.initComponent.call(this);this.activeEditor=null;this.editors=new Array();this.colModel.getColumnsBy(function(cfg,index){if(cfg.editor!=undefined){var ce=cfg.getCellEditor(index);if(cfg.hidden===true){ce.hidden=true;}ce.col=index;ce.dataField=cfg.dataIndex;ce.field.msgTarget="title";ce.field.validateOnBlur=false;ce.onShow=function(){if(this.hidden===true){return ;}this.el.show();if(this.hideEl!==false){this.boundEl.hide();}this.field.show();};this.editors.push(ce);if(cfg.editorConfig!=undefined){if(cfg.editorConfig.init){cfg.editorConfig.init.createDelegate(ce,[this,cfg])();delete cfg.editorConfig.init;}Ext.apply(ce,cfg.editorConfig);ce.interruptSave=(cfg.editorConfig.save!=undefined);ce.interruptRead=(cfg.editorConfig.read!=undefined);}}},this);this.addEvents("beforeupdate","beforeentryedit");},afterRender:function(){for(var i=0;i<this.editors.length;i++){this.editors[i].parentEl=this.el;}lib.RowEditorGrid.RowEditorGrid.superclass.afterRender.call(this);},onDestroy:function(){try{lib.RowEditorGrid.RowEditorGrid.superclass.onDestroy.call(this);}catch(e){}},getEditors:function(){return this.editors;},startEditing:function(row,col){if(!this.rendered||row==this.activRow){return ;}this.stopEditing(this.autoSave);var crow=this.view.getRow(row);if(this.view.mainBody.dom.innerHTML==""||typeof (crow)=="undefined"){this.startEditing.defer(500,this,[row,col]);return false;}this.activRow=row;var r=this.store.getAt(row);if(this.fireEvent("beforeentryedit",this,r,row)===false){return ;}if(!col){col=this.editors[0].col;}for(var i=this.editors.length-1;i>-1;i--){var ed=this.editors[i];ed.row=row;ed.record=r;ed.startEdit(this.view.getCell(row,ed.col).firstChild,r.data[ed.dataField]);ed.field.clearInvalid();if(col==ed.col){ed.field.focus();}ed.editing=false;}},stopEditing:function(flag){if(flag==undefined){return ;}if(typeof (this.activRow)=="undefined"||this.activRow==null){return ;}var row=this.activRow;var hideAndSave={hide:true,save:flag};var r=this.store.getAt(row);if(this.fireEvent("beforeupdate",this,r,row,this.editors,hideAndSave)===false){return false;}flag=hideAndSave.save;this.activRow=null;for(var i=this.editors.length-1;i>-1;i--){var ed=this.editors[i];ed.editing=true;if(flag){if(ed.interruptSave){ed.save(this,r,row);}else{if(this.showDirtyMark){r.set(ed.dataField,ed.getValue());}else{var edcs=r.editing;r.editing=true;r.set(ed.dataField,ed.getValue());r.modified={};r.editing=edcs;if(!r.editing&&r.store){r.store.afterEdit(r);}}}}if(hideAndSave.hide){ed.hide();}}},regist:function(obj,st,cmv){if(typeof (obj)!="undefined"){st.on("load",cmv,obj);}this.needToRefreshFlag++;},checkToRefresh:function(){if(--this.needToRefreshFlag==0){this.getView().refresh();}}});Ext.reg("roweditorgrid",lib.RowEditorGrid.RowEditorGrid);lib.RowEditorGrid.RowEditorGrid.ComboBoxConfig=function(skipInit){this.skipInit=skipInit;this.init=function(grid,config){if(this.skipInit){return ;}this.dataField=config.realValueIndex;this.textField=config.dataIndex;var st=grid.getStore();var cmv=function(store,recs){var combo=this.field;for(var i=0;i<recs.length;i++){var d=recs[i].data;if(d[this.textField]==""){if(combo.findRecord){var r=combo.findRecord(combo.valueField,d[this.dataField]);if(r){d[this.textField]=r.get(combo.displayField);}}}}grid.checkToRefresh();};grid.regist(this,st,cmv);};this.save=function(grid,rec,rowIndex){var v=this.getValue();rec.set(this.dataField,v);var combo=this.field;if(combo.findRecord){var r=combo.findRecord(combo.valueField,v);if(r){rec.set(this.textField,r.data[combo.displayField]);}}};};lib.RowEditorGrid.RowEditorGrid.ComboBoxRenderer=function(combo){var cb=combo;return function(value){var r=cb.store.findBy(function(rec){return rec.data[cb.valueField]==value;});return(r==-1)?value:cb.store.getAt(r).get(cb.displayField);};};