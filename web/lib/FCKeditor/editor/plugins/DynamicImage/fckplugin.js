FCKCommands.RegisterCommand("DynamicImage",new FCKExtCommand("DynamicImage",FCKLang.DynamicImageDlgTitle,function(A,E){var D="/lib/FCKeditor/editor/plugins/DynamicImage/getImagePlugin.jcp";this.imageSelect=new A.form.ComboBox({fieldLabel:"查询选择".loc(),hiddenName:"queryTable",width:200,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"query",query_id:E.parent_id}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"查询必须选择".loc()});this.itemSelect=new A.form.ComboBox({fieldLabel:"图片数据项".loc(),hiddenName:"item",width:200,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"item"}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"图片数据项必须选择".loc()});this.fileNameSelect=new A.form.ComboBox({fieldLabel:"文件名称项".loc(),hiddenName:"fileName",width:200,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"fileName"}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"文件名称项必须选择".loc()});this.fileTypeSelect=new A.form.ComboBox({fieldLabel:"文件类型项".loc(),hiddenName:"fileType",width:200,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"fileType"}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"文件类型项必须选择".loc()});this.fileSizeSelect=new A.form.ComboBox({fieldLabel:"文件大小项".loc(),hiddenName:"fileSize",width:200,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"fileSize"}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"文件大小项必须选择".loc()});this.ImageForm=new A.form.FormPanel({labelAlign:"right",url:D,method:"POST",border:false,height:200,autoScroll:true,bodyStyle:"padding:10px 0px 0px 0px;background:#FFFFFF;",items:[this.imageSelect,this.itemSelect,this.fileNameSelect,this.fileTypeSelect,this.fileSizeSelect,{xtype:"numberfield",fieldLabel:"宽度".loc(),name:"Width",minLength:0,width:200,allowBlank:false,blankText:"宽度必须填写".loc(),maxLength:60},{xtype:"numberfield",fieldLabel:"高度".loc(),name:"Height",minLength:0,width:200,allowBlank:false,blankText:"高度必须填写".loc(),maxLength:60},{xtype:"combo",fieldLabel:"对齐方式".loc(),hiddenName:"align",width:200,store:new A.data.SimpleStore({fields:["value","text"],data:[["Left","左对齐".loc()],["absBottom","绝对底边".loc()],["absMiddle","绝对居中".loc()],["Baseline","基线".loc()],["Bottom","底边".loc()],["Middle","居中".loc()],["Right","右对齐".loc()],["Text Top","文本上方".loc()],["Top","顶端".loc()]]}),valueField:"value",displayField:"text",triggerAction:"all",mode:"local",readOnly:true}]});this.windowCancel=function(){C.close();};var B=this.ImageForm.form;this.windowConfirm=function(){if(B.isValid()){var H=this.imageSelect.getValue();var L="dataColumn_"+B.findField("item").getRawValue();var M="width_"+B.findField("Width").getValue();var K="height_"+B.findField("Height").getValue();var N=B.findField("align").getValue();var J="fileName_"+B.findField("fileName").getRawValue();var O="fileType_"+B.findField("fileType").getRawValue();var I="fileSize_"+B.findField("fileSize").getRawValue();if(N==""){B.findField("align").setValue("Left");N=B.findField("align").getValue();}var G="align_"+N;var F=H+"_"+L+"_"+M+"_"+K+"_"+G+"_"+J+"_"+O+"_"+I;FCKDynamicImages.Add(F);C.close();}else{A.msg("error","数据不能提交,请修改表单中标识的错误!".loc());}};var C=new A.Window({title:"插入动态编辑图片".loc(),layout:"fit",width:350,height:300,closeAction:"hide",plain:true,modal:true,border:false,items:[this.ImageForm],buttons:[{text:"确定".loc(),scope:this,handler:this.windowConfirm},{text:"取消".loc(),scope:this,handler:this.windowCancel}]});C.show();this.imageSelect.on("select",function(){if(this.imageSelect.oldValue==this.imageSelect.getValue()){return ;}this.imageSelect.oldValue=this.imageSelect.getValue();var H=this.imageSelect.getValue();var I=B.findField("item");var G=B.findField("fileName");var F=B.findField("fileType");var J=B.findField("fileSize");I.store.load({params:{query_id:H}});G.store.load({params:{query_id:H}});F.store.load({params:{query_id:H}});J.store.load({params:{query_id:H}});},this);}));var oDynamicImageItem=new FCKToolbarButton("DynamicImage",FCKLang.DynamicImageBtn);oDynamicImageItem.IconPath=FCKPlugins.Items.DynamicImage.Path+"DynamicImage.gif";FCKToolbarItems.RegisterItem("DynamicImage",oDynamicImageItem);var FCKDynamicImages=new Object();FCKDynamicImages.Add=function(A){var B=FCK.CreateElement("SPAN");this.SetupSpan(B,A);};FCKDynamicImages.SetupSpan=function(B,A){B.innerHTML="${DynamicImage_"+A+"}";B.style.backgroundColor="#ffff00";B.style.color="#000000";if(FCKBrowserInfo.IsGecko){B.style.cursor="default";}B._fckDynamicImage=A;B.contentEditable=false;B.onresizestart=function(){FCK.EditorWindow.event.returnValue=false;return false;};};FCKDynamicImages._SetupClickListener=function(){FCKDynamicImages._ClickListener=function(A){if(A.target.tagName=="SPAN"&&A.target._fckDynamicImage){FCKSelection.SelectNode(A.target);}};FCK.EditorDocument.addEventListener("click",FCKDynamicImages._ClickListener,true);};FCKDynamicImages.OnDoubleClick=function(A){if(A.tagName=="SPAN"&&A._fckDynamicImage){FCKCommands.GetCommand("DynamicImage").Execute();}};FCK.RegisterDoubleClickHandler(FCKDynamicImages.OnDoubleClick,"SPAN");FCKDynamicImages.Exist=function(B){var A=FCK.EditorDocument.getElementsByTagName("SPAN");for(var C=0;C<A.length;C++){if(A[C]._fckDynamicImage==B){return true;}}};if(FCKBrowserInfo.IsIE){FCKDynamicImages.Redraw=function(){var A=FCK.EditorDocument.body.innerText.match(/\[\[[^\[\]]+\]\]/g);if(!A){return ;}var D=FCK.EditorDocument.body.createTextRange();for(var B=0;B<A.length;B++){if(D.findText(A[B])){var C=A[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];D.pasteHTML('<span style="color: #000000; background-color: #ffff00" contenteditable="false" _fckDynamicImage="'+C+'">'+A[B]+"</span>");}}};}else{FCKDynamicImages.Redraw=function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG){return ;}var D=FCK.EditorDocument.createTreeWalker(FCK.EditorDocument.body,NodeFilter.SHOW_TEXT,FCKDynamicImages._AcceptNode,true);var A=new Array();while(oNode=D.nextNode()){A[A.length]=oNode;}for(var G=0;G<A.length;G++){var C=A[G].nodeValue.split(/(\[\[[^\[\]]+\]\])/g);for(var B=0;B<C.length;B++){alert(C[B]);if(C[B].length>0){if(C[B].indexOf("${")==0){var F=C[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];var E=FCK.EditorDocument.createElement("span");FCKDynamicImages.SetupSpan(E,F);A[G].parentNode.insertBefore(E,A[G]);}else{A[G].parentNode.insertBefore(FCK.EditorDocument.createTextNode(C[B]),A[G]);}}}A[G].parentNode.removeChild(A[G]);}FCKDynamicImages._SetupClickListener();};FCKDynamicImages._AcceptNode=function(A){if(/\[\[[^\[\]]+\]\]/.test(A.nodeValue)){return NodeFilter.FILTER_ACCEPT;}else{return NodeFilter.FILTER_SKIP;}};}FCK.Events.AttachEvent("OnAfterSetHTML",FCKDynamicImages.Redraw);FCKXHtml.TagProcessors.span=function(A,B){if(B._fckDynamicImage){A=FCKXHtml.XML.createTextNode("${DynamicImage_"+B._fckDynamicImage+"}");}else{FCKXHtml._AppendChildNodes(A,B,false);}return A;};