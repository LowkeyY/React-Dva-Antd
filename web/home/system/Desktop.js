Ext.Desktop=Ext.extend(Ext.util.Observable,{app:null,cmenu:new Ext.menu.Menu(),shortcuts:null,windows:new Ext.WindowGroup(),activeWindow:null,constructor:function(A){this.addEvents({winactivate:true,winbeforeclose:true,windeactivate:true});this.app=A;this.el=Ext.getBody().createChild({tag:"div",cls:"x-desktop"});this.taskbar=new Ext.ux.TaskBar(A);this.shortcuts=new Ext.ux.Shortcuts(this);Ext.Desktop.superclass.constructor.call(this);this.initEvents();this.layout();this.windows.zseed=5000;},initEvents:function(){Ext.EventManager.onWindowResize(this.layout,this);this.el.on("contextmenu",function(B){if(B.target.id===this.el.id){B.stopEvent();if(!this.cmenu.el){this.cmenu.render();}var A=B.getXY();A[1]-=this.cmenu.el.getHeight();this.cmenu.showAt(A);}},this);},createWindow:function(B,A){var C=new (A||Ext.Window)(Ext.applyIf(B||{},{manager:this.windows,draggable:false,resizable:false,tools:null}));C.render(this.el);C.taskButton=this.taskbar.taskButtonPanel.add(C);C.cmenu=new Ext.menu.Menu({items:[]});C.animateTarget=C.taskButton.el;C.on({activate:{fn:function(D){this.markActive(D);this.fireEvent("winactivate",this,D);},scope:this},beforeclose:{fn:function(D){this.fireEvent("winbeforeclose",this,D);},scope:this},beforeshow:{fn:this.markActive,scope:this},deactivate:{fn:function(D){this.markInactive(D);this.fireEvent("windeactivate",this,D);},scope:this},minimize:{fn:this.minimizeWin,scope:this},close:{fn:this.removeWin,scope:this}});this.layout();return C;},minimizeWin:function(A){A.minimized=true;A.hide();},markActive:function(A){if(this.activeWindow&&this.activeWindow!=A){this.markInactive(this.activeWindow);}this.taskbar.setActiveButton(A.taskButton);this.activeWindow=A;Ext.fly(A.taskButton.el).addClass("active-win");A.minimized=false;},markInactive:function(A){if(A==this.activeWindow){this.activeWindow=null;Ext.fly(A.taskButton.el).removeClass("active-win");}},removeWin:function(A){this.taskbar.taskButtonPanel.remove(A.taskButton);this.layout();},layout:function(){this.el.setHeight(Ext.lib.Dom.getViewHeight()-this.taskbar.el.getHeight());},getManager:function(){return this.windows;},getWindow:function(A){return this.windows.get(A);},getViewHeight:function(){return(Ext.lib.Dom.getViewHeight()-this.taskbar.el.getHeight());},getViewWidth:function(){return Ext.lib.Dom.getViewWidth();},getWinWidth:function(){var A=this.getViewWidth();return A<200?200:A;},getWinHeight:function(){var A=this.getViewHeight();return A<100?100:A;},getWinX:function(A){return(Ext.lib.Dom.getViewWidth()-A)/2;},getWinY:function(A){return(Ext.lib.Dom.getViewHeight()-this.taskbar.el.getHeight()-A)/2;},setBackgroundColor:function(A){if(A){Ext.get(document.body).setStyle("background-color","#"+A);this.app.styles.backgroundcolor=A;}},setFontColor:function(A){if(A){Ext.util.CSS.updateRule(".ux-shortcut-btn-text","color","#"+A);this.app.styles.fontcolor=A;}},setTheme:function(A){if(A&&A.id&&A.name&&A.pathtofile){Ext.util.CSS.swapStyleSheet("theme",A.pathtofile);this.app.styles.theme=A;}},setTransparency:function(A){if(A==true||typeof (A)=="number"){A=75;if(A>=0&&A<=80){this.taskbar.el.addClass("transparent");Ext.util.CSS.updateRule(".transparent","opacity",A/100);Ext.util.CSS.updateRule(".transparent","-moz-opacity",A/100);Ext.util.CSS.updateRule(".transparent","filter","alpha(opacity="+A+")");}else{if(A>80){A=80;this.taskbar.el.addClass("transparent");Ext.util.CSS.updateRule(".transparent","opacity",A/100);Ext.util.CSS.updateRule(".transparent","-moz-opacity",A/100);Ext.util.CSS.updateRule(".transparent","filter","alpha(opacity="+A+")");}}}this.app.styles.transparency=A;},setWallpaper:function(E){if(E&&E.id&&E.name&&E.pathtofile){var D=this.showNotification({html:"<pre>"+"加载背景".loc()+"...</pre>",title:"请等待".loc()});var B=new Image();B.src=E.pathtofile;var A=new Ext.util.DelayedTask(C,this);A.delay(10);this.app.styles.wallpaper=E;}function C(){if(B.complete){A.cancel();this.hideNotification(D);document.body.background=B.src;}else{A.delay(10);}}},setWallpaperPosition:function(B){if(B){if(B==="center"){var A=Ext.get(document.body);A.removeClass("wallpaper-tile");A.addClass("wallpaper-center");}else{if(B==="tile"){var A=Ext.get(document.body);A.removeClass("wallpaper-center");A.addClass("wallpaper-tile");}}this.app.styles.wallpaperposition=B;}},showNotification:function(A){var B=new Ext.ux.Notification(Ext.apply({animateTarget:this.taskbar.el,autoDestroy:true,hideDelay:5000,html:"",iconCls:"x-icon-waiting",title:""},A));B.show();return B;},hideNotification:function(B,A){if(B){(function(){B.animHide();B.manager.unregister(B);}).defer(A||3000);}},addAutoRun:function(C){var A=this.app.getModule(C);var B=this.config.autorun;if(B&&A&&!A.autorun){A.autorun=true;B.push(C);}},removeAutoRun:function(D){var A=this.app.getModule(D);var C=this.config.autorun;if(C&&A&&A.autorun){var B=0;while(B<C.length){if(C[B]==D){C.splice(B,1);}else{B++;}}A.autorun=null;}},addContextMenuItem:function(B){var A=this.app.getModule(B);if(A&&!A.contextMenuItem){this.cmenu.add(A.launcher);}},addShortcut:function(G,E){var A=this.app.getModule(G);if(A&&!A.shortcut){var F=A.launcher;if(!F.shortcutIconCls){var D="";F.deskIcon=F.desktopIcon||F.deskIcon;if(F.deskIcon){D=".icon_"+G+" img {width:48px;height:48px;background-image: url(/themes/icon"+F.deskIcon+");filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='/themes/icon"+F.deskIcon+"', sizingMethod='scale');}";}else{D=".icon_"+G+" img {width:48px;height:48px;background-image: url(/themes/icon/xp48d/cubes.gif);filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='/themes/icon/xp48d/cubes.gif', sizingMethod='scale');}";}Ext.util.CSS.createStyleSheet(D,"tempCls");F.shortcutIconCls="icon_"+G;}var C=this.getWinHeight();var B=this.getWinWidth();if(F.winWidth){B=parseInt(F.winWidth);}if(F.winHeight){C=parseInt(F.winHeight);}A.shortcut=this.shortcuts.addShortcut(Ext.apply({windowId:F.windowId,handler:F.handler,windowIcon:F.icon,iconCls:F.shortcutIconCls,scope:F.scope,url:F.url,menuStyle:F.menuStyle,isIFrame:F.isIFrame,winWidth:B,winHeight:C,x:F.x,y:F.y,text:F.text,tooltip:F.tooltip||""},this.setPotals(F,"openType,faceAppUrl,faceAppIsUpdate,faceAppUpdateTimer,winDraggable,winResizable")));if(E){this.config.shortcuts.push(G);}}},removeShortcut:function(E,B){var A=this.app.getModule(E);if(A&&A.shortcut){this.shortcuts.removeShortcut(A.shortcut);A.shortcut=null;if(B){var D=this.config.shortcuts;var C=0;while(C<D.length){if(D[C]==E){D.splice(C,1);}else{C++;}}}}},addQuickStartButton:function(G,E){var A=this.app.getModule(G);if(A&&!A.quickStartButton){var F=A.launcher;F.icon=F.fastlinkIcon||F.icon;if(!F.iconCls){var D="";if(F.icon){D=".iconQuickStart_"+G+" {background-image: url('"+F.icon+"') !important;}";}else{D=".iconQuickStart_"+G+" {background-image: url(/themes/icon/all/application.gif) !important;}";}Ext.util.CSS.createStyleSheet(D,"tempCls");F.iconCls="iconQuickStart_"+G;}var C=this.getWinHeight();var B=this.getWinWidth();if(F.winWidth){B=parseInt(F.winWidth);}if(F.winHeight){C=parseInt(F.winHeight);}A.quickStartButton=this.taskbar.quickStartPanel.add(Ext.apply({windowId:F.windowId,url:F.url,winWidth:B,winHeight:C,handler:F.handler,menuStyle:F.menuStyle,icon:F.icon,iconCls:F.iconCls,scope:F.scope,isIFrame:F.isIFrame,text:F.text,tooltip:F.tooltip||F.text},this.setPotals(F,"openType")));if(E){this.config.quickstart.push(G);}}},setPotals:function(A,C){var B={};if(A&&C){Ext.copyTo(B,A,C);}return B;},removeQuickStartButton:function(E,C){var B=this.app.getModule(E);if(B&&B.quickStartButton){this.taskbar.quickStartPanel.remove(B.quickStartButton);B.quickStartButton=null;if(updateConfig){var A=this.config.quickstart;var D=0;while(D<A.length){if(A[D]==E){A.splice(D,1);}else{D++;}}}}}});Ext.ux.NotificationMgr={positions:[]};Ext.ux.Notification=Ext.extend(Ext.Window,{initComponent:function(){Ext.apply(this,{iconCls:this.iconCls||"x-icon-information",width:200,autoHeight:true,closable:true,plain:false,draggable:false,bodyStyle:"text-align:left;padding:10px;",resizable:false});if(this.autoDestroy){this.task=new Ext.util.DelayedTask(this.close,this);}else{this.closable=true;}Ext.ux.Notification.superclass.initComponent.call(this);},setMessage:function(A){this.body.update(A);},setTitle:function(B,A){Ext.ux.Notification.superclass.setTitle.call(this,B,A||this.iconCls);},onRender:function(B,A){Ext.ux.Notification.superclass.onRender.call(this,B,A);},onDestroy:function(){Ext.ux.NotificationMgr.positions.remove(this.pos);Ext.ux.Notification.superclass.onDestroy.call(this);},afterShow:function(){Ext.ux.Notification.superclass.afterShow.call(this);this.on("move",function(){Ext.ux.NotificationMgr.positions.remove(this.pos);if(this.autoDestroy){this.task.cancel();}},this);if(this.autoDestroy){this.task.delay(this.hideDelay||5000);}},animShow:function(){this.pos=0;while(Ext.ux.NotificationMgr.positions.indexOf(this.pos)>-1){this.pos++;}Ext.ux.NotificationMgr.positions.push(this.pos);this.setSize(200,100);this.el.alignTo(this.animateTarget||document,"br-tr",[-1,-1-((this.getSize().height+10)*this.pos)]);this.el.slideIn("b",{duration:0.7,callback:this.afterShow,scope:this});},animHide:function(){Ext.ux.NotificationMgr.positions.remove(this.pos);this.el.ghost("b",{duration:1,remove:true});}});