FCKCommands.RegisterCommand("Chart",new FCKExtCommand("Chart",FCKLang.ChartDlgTitle,function(A,D){var C="/lib/FCKeditor/editor/plugins/Chart/getChartPlugin.jcp";this.chartSelect=new A.form.ComboBox({fieldLabel:"图表选择".loc(),hiddenName:"queryTable",width:200,store:new A.data.JsonStore({url:C,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"chart",chart_id:D.parent_id}}),valueField:"value",displayField:"text",allowBlank:false,triggerAction:"all",mode:"local",blankText:"图表必须选择".loc()});this.ChartForm=new A.form.FormPanel({labelAlign:"right",url:C,method:"POST",border:false,height:200,autoScroll:true,bodyStyle:"padding:10px 0px 0px 0px;background:#FFFFFF;",items:[{columnWidth:1,layout:"form",clear:true,border:false,items:[this.chartSelect,{xtype:"numberfield",fieldLabel:"宽度".loc(),name:"Width",minLength:0,width:200,allowBlank:false,blankText:"宽度必须填写".loc(),maxLength:60},{xtype:"numberfield",fieldLabel:"高度".loc(),name:"Height",minLength:0,width:200,allowBlank:false,blankText:"高度必须填写".loc(),maxLength:60},{xtype:"combo",fieldLabel:"对齐方式".loc(),hiddenName:"align",width:200,store:new A.data.SimpleStore({fields:["value","text"],data:[["Left","左对齐".loc()],["absBottom","绝对底边".loc()],["absMiddle","绝对居中".loc()],["Baseline","基线".loc()],["Bottom","底边".loc()],["Middle","居中".loc()],["Right","右对齐".loc()],["Text Top","文本上方".loc()],["Top","顶端".loc()]]}),valueField:"value",displayField:"text",triggerAction:"all",mode:"local",readOnly:true}]}]});this.windowCancel=function(){B.close();};this.windowConfirm=function(){var I=this.ChartForm.form;if(I.isValid()){var F=this.chartSelect.getValue();var H="width_"+I.findField("Width").getValue();var G="height_"+I.findField("Height").getValue();var J=I.findField("align").getValue();if(J==""){I.findField("align").setValue("Left");J=I.findField("align").getValue();}var K="align_"+J;var E=F+"_"+H+"_"+G+"_"+K;FCKCharts.Add(E);B.close();}else{A.msg("error","数据不能提交,请修改表单中标识的错误!".loc());}};var B=new A.Window({title:"图标选择".loc(),layout:"fit",width:350,height:200,closeAction:"hide",plain:true,modal:true,border:false,items:[this.ChartForm],buttons:[{text:"确定".loc(),scope:this,handler:this.windowConfirm},{text:"取消".loc(),scope:this,handler:this.windowCancel}]});B.show();}));var oChartItem=new FCKToolbarButton("Chart",FCKLang.ChartBtn);oChartItem.IconPath=FCKPlugins.Items.Chart.Path+"Chart.gif";FCKToolbarItems.RegisterItem("Chart",oChartItem);var FCKCharts=new Object();FCKCharts.Add=function(A){var B=FCK.CreateElement("SPAN");this.SetupSpan(B,A);};FCKCharts.SetupSpan=function(B,A){B.innerHTML="${Chart_"+A+"}";B.style.backgroundColor="#ffff00";B.style.color="#000000";if(FCKBrowserInfo.IsGecko){B.style.cursor="default";}B._fckChart=A;B.contentEditable=false;B.onresizestart=function(){FCK.EditorWindow.event.returnValue=false;return false;};};FCKCharts._SetupClickListener=function(){FCKCharts._ClickListener=function(A){if(A.target.tagName=="SPAN"&&A.target._fckChart){FCKSelection.SelectNode(A.target);}};FCK.EditorDocument.addEventListener("click",FCKCharts._ClickListener,true);};FCKCharts.OnDoubleClick=function(A){if(A.tagName=="SPAN"&&A._fckChart){FCKCommands.GetCommand("Chart").Execute();}};FCK.RegisterDoubleClickHandler(FCKCharts.OnDoubleClick,"SPAN");FCKCharts.Exist=function(B){var A=FCK.EditorDocument.getElementsByTagName("SPAN");for(var C=0;C<A.length;C++){if(A[C]._fckChart==B){return true;}}};if(FCKBrowserInfo.IsIE){FCKCharts.Redraw=function(){var A=FCK.EditorDocument.body.innerText.match(/\[\[[^\[\]]+\]\]/g);if(!A){return ;}var D=FCK.EditorDocument.body.createTextRange();for(var B=0;B<A.length;B++){if(D.findText(A[B])){var C=A[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];D.pasteHTML('<span style="color: #000000; background-color: #ffff00" contenteditable="false" _fckChart="'+C+'">'+A[B]+"</span>");}}};}else{FCKCharts.Redraw=function(){var D=FCK.EditorDocument.createTreeWalker(FCK.EditorDocument.body,NodeFilter.SHOW_TEXT,FCKCharts._AcceptNode,true);var A=new Array();while(oNode=D.nextNode()){A[A.length]=oNode;}for(var G=0;G<A.length;G++){var C=A[G].nodeValue.split(/(\[\[[^\[\]]+\]\])/g);for(var B=0;B<C.length;B++){if(C[B].length>0){if(C[B].indexOf("${")==0){var F=C[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];var E=FCK.EditorDocument.createElement("span");FCKCharts.SetupSpan(E,F);A[G].parentNode.insertBefore(E,A[G]);}else{A[G].parentNode.insertBefore(FCK.EditorDocument.createTextNode(C[B]),A[G]);}}}A[G].parentNode.removeChild(A[G]);}FCKCharts._SetupClickListener();};FCKCharts._AcceptNode=function(A){if(/\[\[[^\[\]]+\]\]/.test(A.nodeValue)){return NodeFilter.FILTER_ACCEPT;}else{return NodeFilter.FILTER_SKIP;}};}FCK.Events.AttachEvent("OnAfterSetHTML",FCKCharts.Redraw);FCKXHtml.TagProcessors.span=function(A,B){if(B._fckChart){A=FCKXHtml.XML.createTextNode("${Chart_"+B._fckChart+"}");}else{FCKXHtml._AppendChildNodes(A,B,false);}return A;};