var FCKExtCommand=function(A,C,B){this.Name=A;this.Title=C;this.func=B;};FCKExtCommand.prototype.Execute=function(A){value=(A)?A.innerHTML:"";window.parent.FCKeditor_OnExtWindow(FCK,this.func,value);};FCKExtCommand.prototype.GetState=function(){return FCK_TRISTATE_OFF;};FCKCommands.RegisterCommand("Query",new FCKExtCommand("Query",FCKLang.QueryDlgTitle,function(A,E,B){var D="/lib/FCKeditor/editor/plugins/Query/getQueryPlugin.jcp";this.tableSelect=new A.form.ComboBox({fieldLabel:"查询选择".loc(),hiddenName:"queryTable",width:180,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"query",query_id:E.parent_id}}),valueField:"value",displayField:"text",triggerAction:"all",allowBlank:false,blankText:"请选择查询!".loc(),mode:"local"});this.itemSelect=new A.form.ComboBox({fieldLabel:"数据项选择".loc(),hiddenName:"queryColumn",width:180,store:new A.data.JsonStore({url:D,root:"items",autoLoad:true,fields:["value","text"],baseParams:{type:"queryCol"}}),valueField:"value",displayField:"text",triggerAction:"all",allowBlank:false,blankText:"请选择数据项!".loc(),mode:"local"});this.QueryForm=new A.form.FormPanel({labelAlign:"right",url:D,method:"POST",border:false,height:200,autoScroll:true,bodyStyle:"padding:10px 0px 0px 0px;background:#FFFFFF;",items:[{columnWidth:1,layout:"form",clear:true,border:false,items:[this.tableSelect,this.itemSelect]}]});this.windowCancel=function(){C.close();};this.windowConfirm=function(){var I=this.QueryForm.form;if(I.isValid()){var G=this.tableSelect.getValue();var H=I.findField("queryColumn").getRawValue();var F=G+"."+H;FCKQuerys.Add(F);C.close();}else{A.msg("error","数据不能提交,请修改表单中标识的错误!".loc());}};var C=new A.Window({title:"插入查询数据项".loc(),layout:"fit",width:350,height:150,closeAction:"hide",plain:true,modal:true,border:false,items:[this.QueryForm],buttons:[{text:"确定".loc(),scope:this,handler:this.windowConfirm},{text:"取消".loc(),scope:this,handler:this.windowCancel}]});C.show();this.tableSelect.on("select",function(){if(this.tableSelect.oldValue==this.tableSelect.getValue()){return ;}this.tableSelect.oldValue=this.tableSelect.getValue();var F=this.tableSelect.getValue();var G=this.QueryForm.form.findField("queryColumn");G.store.load({params:{query_id:F}});},this);}));var oQueryItem=new FCKToolbarButton("Query",FCKLang.QueryBtn);oQueryItem.IconPath=FCKPlugins.Items.Query.Path+"Query.gif";FCKToolbarItems.RegisterItem("Query",oQueryItem);var FCKQuerys=new Object();FCKQuerys.Add=function(A){var B=FCK.CreateElement("SPAN");this.SetupSpan(B,A);};FCKQuerys.SetupSpan=function(B,A){B.innerHTML="${Query_"+A+"}";B.style.backgroundColor="#ffff00";B.style.color="#000000";if(FCKBrowserInfo.IsGecko){B.style.cursor="default";}B._fckQuery=A;B.contentEditable=false;B.onresizestart=function(){FCK.EditorWindow.event.returnValue=false;return false;};};FCKQuerys._SetupClickListener=function(){FCKQuerys._ClickListener=function(A){if(A.target.tagName=="SPAN"&&A.target._fckQuery){FCKSelection.SelectNode(A.target);}};FCK.EditorDocument.addEventListener("click",FCKQuerys._ClickListener,true);};FCKQuerys.OnDoubleClick=function(A){if(A.tagName=="SPAN"&&A._fckQuery){FCKCommands.GetCommand("Query").Execute(A);}};FCK.RegisterDoubleClickHandler(FCKQuerys.OnDoubleClick,"SPAN");FCKQuerys.Exist=function(B){var A=FCK.EditorDocument.getElementsByTagName("SPAN");for(var C=0;C<A.length;C++){if(A[C]._fckQuery==B){return true;}}};if(FCKBrowserInfo.IsIE){FCKQuerys.Redraw=function(){var A=FCK.EditorDocument.body.innerText.match(/\[\[[^\[\]]+\]\]/g);if(!A){return ;}var D=FCK.EditorDocument.body.createTextRange();for(var B=0;B<A.length;B++){if(D.findText(A[B])){var C=A[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];D.pasteHTML('<span style="color: #000000; background-color: #ffff00" contenteditable="false" _fckQuery="'+C+'">'+A[B]+"</span>");}}};}else{FCKQuerys.Redraw=function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG){return ;}var D=FCK.EditorDocument.createTreeWalker(FCK.EditorDocument.body,NodeFilter.SHOW_TEXT,FCKQuerys._AcceptNode,true);var A=new Array();while(oNode=D.nextNode()){A[A.length]=oNode;}for(var G=0;G<A.length;G++){var C=A[G].nodeValue.split(/(\[\[[^\[\]]+\]\])/g);for(var B=0;B<C.length;B++){if(C[B].length>0){if(C[B].indexOf("${")==0){var F=C[B].match(/\[\[\s*([^\]]*?)\s*\]\]/)[1];var E=FCK.EditorDocument.createElement("span");FCKQuerys.SetupSpan(E,F);A[G].parentNode.insertBefore(E,A[G]);}else{A[G].parentNode.insertBefore(FCK.EditorDocument.createTextNode(C[B]),A[G]);}}}A[G].parentNode.removeChild(A[G]);}FCKQuerys._SetupClickListener();};FCKQuerys._AcceptNode=function(A){if(/\[\[[^\[\]]+\]\]/.test(A.nodeValue)){return NodeFilter.FILTER_ACCEPT;}else{return NodeFilter.FILTER_SKIP;}};}FCK.Events.AttachEvent("OnAfterSetHTML",FCKQuerys.Redraw);FCKXHtml.TagProcessors.span=function(A,B){if(B._fckQuery){A=FCKXHtml.XML.createTextNode("${Query_"+B._fckQuery+"}");}else{FCKXHtml._AppendChildNodes(A,B,false);}return A;};